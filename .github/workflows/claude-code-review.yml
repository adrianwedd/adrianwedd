name: ðŸ” Claude Code Review Excellence

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "**/*.js"
      - "**/*.ts" 
      - "**/*.jsx"
      - "**/*.tsx"
      - "**/*.css"
      - "**/*.html"
      - "**/*.json"
      - "**/*.md"
      - "**/*.yml"
      - "**/*.yaml"

jobs:
  claude-review:
    name: ðŸ§  AI-Powered Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    
    steps:
      - name: ðŸ“‹ PR Analysis Initialization
        run: |
          echo "ðŸ” **CLAUDE CODE REVIEW INITIATED**"
          echo "ðŸ“… Review started at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ðŸ”€ PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "ðŸŒ¿ Branch: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}"
          echo "ðŸ“Š Files changed: ${{ github.event.pull_request.changed_files }}"
          echo "âž• Additions: ${{ github.event.pull_request.additions }}"
          echo "âž– Deletions: ${{ github.event.pull_request.deletions }}"
          echo "ðŸŽ¯ Contributor level: ${{ github.event.pull_request.author_association }}"
          echo ""

      - name: ðŸ“¥ Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Pre-Review Analysis
        run: |
          echo "ðŸ”¬ **PERFORMING PRE-REVIEW ANALYSIS**"
          echo ""
          
          # Analyze file changes
          git diff --name-status HEAD~1 HEAD | while read status file; do
            case $status in
              A) echo "âœ¨ NEW: $file" ;;
              M) echo "ðŸ”§ MODIFIED: $file" ;;
              D) echo "ðŸ—‘ï¸ DELETED: $file" ;;
              R*) echo "ðŸ“ RENAMED: $file" ;;
            esac
          done
          
          echo ""
          echo "ðŸ“ˆ **Change Statistics:**"
          echo "- JavaScript/TypeScript files: $(git diff --name-only HEAD~1 HEAD | grep -E '\.(js|ts|jsx|tsx)$' | wc -l)"
          echo "- CSS/Style files: $(git diff --name-only HEAD~1 HEAD | grep -E '\.(css|scss|sass)$' | wc -l)"  
          echo "- Test files: $(git diff --name-only HEAD~1 HEAD | grep -E '\.(test|spec)\.' | wc -l)"
          echo "- Config files: $(git diff --name-only HEAD~1 HEAD | grep -E '\.(json|yml|yaml|config)' | wc -l)"
          echo "- Documentation: $(git diff --name-only HEAD~1 HEAD | grep -E '\.md$' | wc -l)"
          echo ""

      - name: ðŸ§  Intelligent Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: "claude-sonnet-4-20250514"
          use_sticky_comment: true
          
          # Intelligent context-aware review prompt
          direct_prompt: |
            ðŸ” **COMPREHENSIVE CODE REVIEW** - PR #${{ github.event.pull_request.number }}
            
            **ðŸ“‹ Review Context:**
            - Author: ${{ github.event.pull_request.user.login }} (${{ github.event.pull_request.author_association }})
            - Files changed: ${{ github.event.pull_request.changed_files }}
            - Lines: +${{ github.event.pull_request.additions }}/-${{ github.event.pull_request.deletions }}
            - Branch: `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            
            **ðŸŽ¯ Review Focus Areas:**
            
            **ðŸ—ï¸ Architecture & Design:**
            - Code organization and structure
            - Design patterns and best practices
            - Maintainability and extensibility
            
            **ðŸ”’ Security & Performance:**
            - Security vulnerabilities and best practices
            - Performance implications and optimizations
            - Resource usage and memory management
            
            **âœ… Quality & Standards:**
            - Code quality and readability
            - Adherence to project coding standards
            - Error handling and edge cases
            
            **ðŸ§ª Testing & Coverage:**
            - Test coverage and quality
            - Edge case handling
            - Integration and unit test adequacy
            
            **â™¿ Accessibility & UX:**
            - Accessibility compliance (WCAG)
            - User experience considerations
            - Cross-browser compatibility
            
            **ðŸ“š Documentation:**
            - Code comments and documentation
            - API documentation updates
            - README and setup instructions
            
            **ðŸŽ¨ Specific File Type Guidelines:**
            - **JavaScript/TypeScript**: Type safety, modern ES features, async/await patterns
            - **CSS/Styling**: Responsive design, performance, maintainability
            - **HTML**: Semantic markup, accessibility attributes
            - **Config files**: Security, environment considerations
            - **Tests**: Coverage, mocking strategies, test organization
            
            **ðŸ¤ Review Style:**
            ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' && 
            '- ðŸŒŸ **First-time contributor detected!** Be encouraging, provide detailed explanations, and welcome them to the project' ||
            '- Provide constructive, actionable feedback with specific examples and suggestions' }}
            
            - Use emoji for visual organization and engagement
            - Highlight both strengths and areas for improvement
            - Suggest specific code improvements when applicable
            - Reference documentation or examples when helpful
            
            **âš¡ Advanced Analysis:**
            - Run linting and type checking if needed
            - Verify terminal compatibility for UI changes
            - Check for potential breaking changes
            - Validate accessibility compliance
            
            Begin your comprehensive review now!

          # Enable comprehensive toolset for thorough analysis
          allowed_tools: |
            Bash(npm run lint)
            Bash(npm run lint:fix)
            Bash(npm run typecheck)
            Bash(npm run test:unit)
            Bash(npm run format-check)
            Bash(npm run lint:css)

      - name: ðŸ“Š Review Completion Summary
        if: always()
        run: |
          echo "ðŸ **CODE REVIEW COMPLETED**"
          echo "ðŸ“… Finished at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… Review outcome: ${{ steps.claude-review.outcome }}"
          echo "ðŸ”€ PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo ""
          
          if [ "${{ steps.claude-review.outcome }}" = "success" ]; then
            echo "ðŸŽ‰ **Review successfully completed!**"
            echo "ðŸ’¬ Claude has provided comprehensive feedback on the pull request"
            echo "ðŸ“ Check the PR comments for detailed analysis and suggestions"
          else
            echo "âš ï¸ **Review encountered issues**"
            echo "ðŸ” Check the workflow logs for troubleshooting information"
          fi
          
          echo ""
          echo "ðŸ“ˆ **Next Steps:**"
          echo "- ðŸ‘€ Review Claude's feedback and suggestions"
          echo "- ðŸ”§ Address any identified issues or improvements"
          echo "- âœ… Update tests if necessary"
          echo "- ðŸ“ Update documentation if applicable"
          echo "- ðŸš€ Ready for merge after addressing feedback"

      - name: ðŸ“‹ Workflow Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Claude Code Review Summary
          
          **ðŸ“Š Review Details:**
          - **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          - **Author:** ${{ github.event.pull_request.user.login }} (${{ github.event.pull_request.author_association }})
          - **Branch:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
          - **Files:** ${{ github.event.pull_request.changed_files }} changed (+${{ github.event.pull_request.additions }}/-${{ github.event.pull_request.deletions }})
          - **Status:** ${{ steps.claude-review.outcome == 'success' && 'âœ… Completed Successfully' || 'âš ï¸ Issues Encountered' }}
          
          **ðŸŽ¯ Review Coverage:**
          - ðŸ—ï¸ Architecture & Design Analysis
          - ðŸ”’ Security & Performance Review  
          - âœ… Code Quality & Standards Check
          - ðŸ§ª Testing & Coverage Evaluation
          - â™¿ Accessibility Compliance Review
          - ðŸ“š Documentation Assessment
          
          **ðŸ’¡ Key Features:**
          - ðŸ§  AI-powered comprehensive analysis
          - ðŸŽ¨ Context-aware file-type specific guidance
          - ðŸ› ï¸ Automated linting and type checking
          - ðŸ“Š Detailed metrics and statistics
          - ðŸ¤ Contributor-level adaptive feedback
          
          ${{ steps.claude-review.outcome == 'success' && 'ðŸŽ‰ **Claude has completed a thorough review!** Check the PR comments for detailed feedback and actionable suggestions.' || 'âš ï¸ **Review incomplete.** Please check the workflow logs and try again.' }}
          EOF

