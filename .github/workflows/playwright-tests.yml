name: ğŸ­ Playwright Testing Excellence

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily comprehensive testing at 2 AM UTC
  workflow_dispatch:
    inputs:
      browser_suite:
        description: 'Browser test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
      test_mode:
        description: 'Test execution mode'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - headed
          - debug
          - smoke-only

env:
  CI: true
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers

jobs:
  pre-flight:
    name: ğŸš€ Pre-Flight Test Analysis
    runs-on: ubuntu-latest
    outputs:
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      browser-matrix: ${{ steps.browsers.outputs.matrix }}
      estimated-duration: ${{ steps.estimation.outputs.duration }}
    steps:
      - name: ğŸ¬ Test Suite Initialization
        run: |
          echo "ğŸ­ **PLAYWRIGHT TESTING SUITE INITIATED**"
          echo "ğŸ“… Started at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Browser suite: ${{ github.event.inputs.browser_suite || 'all' }}"
          echo "ğŸ¯ Test mode: ${{ github.event.inputs.test_mode || 'normal' }}"
          echo "ğŸ¤– Triggered by: ${{ github.event_name }}"
          echo ""

      - name: ğŸ“¥ Repository Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Test Strategy Determination
        id: strategy
        run: |
          echo "ğŸ² **DETERMINING OPTIMAL TEST STRATEGY**"
          
          BROWSER_SUITE="${{ github.event.inputs.browser_suite || 'all' }}"
          TEST_MODE="${{ github.event.inputs.test_mode || 'normal' }}"
          
          if [ "$TEST_MODE" = "smoke-only" ]; then
            STRATEGY="smoke"
            echo "ğŸ’¨ Selected: Smoke test strategy"
          elif [ "$TEST_MODE" = "debug" ]; then
            STRATEGY="debug"
            echo "ğŸ› Selected: Debug test strategy"
          elif [ "$BROWSER_SUITE" != "all" ]; then
            STRATEGY="targeted"
            echo "ğŸ¯ Selected: Targeted browser strategy ($BROWSER_SUITE)"
          else
            STRATEGY="comprehensive"
            echo "ğŸ”¬ Selected: Comprehensive cross-browser strategy"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT

      - name: ğŸŒ Browser Matrix Configuration
        id: browsers
        run: |
          echo "ğŸŒ **CONFIGURING BROWSER MATRIX**"
          
          BROWSER_SUITE="${{ github.event.inputs.browser_suite || 'all' }}"
          
          if [ "$BROWSER_SUITE" = "all" ]; then
            MATRIX='["chromium", "firefox", "webkit"]'
          else
            MATRIX='["'$BROWSER_SUITE'"]'
          fi
          
          echo "Browser matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: â±ï¸ Test Duration Estimation
        id: estimation
        run: |
          echo "â±ï¸ **ESTIMATING TEST EXECUTION TIME**"
          
          TEST_FILES=$(find tests -name "*.spec.js" -o -name "*.spec.ts" | wc -l)
          BROWSER_COUNT=$(echo '${{ steps.browsers.outputs.matrix }}' | jq length)
          STRATEGY="${{ steps.strategy.outputs.strategy }}"
          
          case $STRATEGY in
            "smoke")
              BASE_TIME=5
              ;;
            "debug")
              BASE_TIME=20
              ;;
            "targeted")
              BASE_TIME=10
              ;;
            *)
              BASE_TIME=15
              ;;
          esac
          
          ESTIMATED_DURATION=$((BASE_TIME * BROWSER_COUNT))
          
          echo "ğŸ“Š **Execution Estimates:**"
          echo "- Test files: $TEST_FILES"
          echo "- Browsers: $BROWSER_COUNT"
          echo "- Strategy: $STRATEGY"
          echo "- Estimated duration: ${ESTIMATED_DURATION} minutes"
          
          echo "duration=$ESTIMATED_DURATION" >> $GITHUB_OUTPUT

  test:
    name: ğŸ¯ Cross-Browser Testing
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: pre-flight
    strategy:
      matrix:
        browser: ${{ fromJson(needs.pre-flight.outputs.browser-matrix) }}
      fail-fast: false
    
    steps:
      - name: ğŸª Browser Test Initialization
        run: |
          echo "ğŸ­ **${{ matrix.browser }} BROWSER TESTING INITIATED**"
          echo "ğŸ¯ Strategy: ${{ needs.pre-flight.outputs.test-strategy }}"
          echo "â±ï¸ Estimated duration: ${{ needs.pre-flight.outputs.estimated-duration }} minutes"
          echo "ğŸŒ Browser: ${{ matrix.browser }}"
          echo ""

      - name: ğŸ“¥ Repository Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js Environment Setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Dependency Installation
        run: |
          echo "ğŸ“¦ **INSTALLING PROJECT DEPENDENCIES**"
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ­ Playwright Browser Installation
        run: |
          echo "ğŸ­ **INSTALLING PLAYWRIGHT BROWSERS**"
          echo "ğŸŒ Installing ${{ matrix.browser }} and dependencies..."
          npx playwright install ${{ matrix.browser }} --with-deps
          echo "âœ… ${{ matrix.browser }} browser installed successfully"

      - name: ğŸ¯ Playwright Test Execution
        run: |
          echo "ğŸ¯ **EXECUTING PLAYWRIGHT TESTS**"
          echo "ğŸŒ Running tests on ${{ matrix.browser }}..."
          echo "ğŸª Test mode: ${{ github.event.inputs.test_mode || 'normal' }}"
          
          # Configure test execution based on mode
          case "${{ github.event.inputs.test_mode || 'normal' }}" in
            "headed")
              EXTRA_ARGS="--headed"
              ;;
            "debug")
              EXTRA_ARGS="--debug --max-failures=3"
              ;;
            "smoke-only")
              EXTRA_ARGS="--grep @smoke"
              ;;
            *)
              EXTRA_ARGS=""
              ;;
          esac
          
          npx playwright test --project=${{ matrix.browser }} $EXTRA_ARGS \
            --reporter=html,json 2>&1 | tee playwright-${{ matrix.browser }}-output.log || {
            echo "âŒ Some tests failed on ${{ matrix.browser }}"
            exit 1
          }
          
          echo "âœ… ${{ matrix.browser }} tests completed"

      - name: ğŸ“Š Test Results Processing
        if: always()
        run: |
          echo "ğŸ“Š **PROCESSING TEST RESULTS FOR ${{ matrix.browser }}**"
          
          if [ -f "test-results.json" ]; then
            echo "ğŸ“ˆ **Test Summary:**"
            jq -r '
              "Total tests: " + (.stats.expected | tostring) +
              "\nPassed: " + (.stats.passed | tostring) +
              "\nFailed: " + (.stats.failed | tostring) +
              "\nSkipped: " + (.stats.skipped | tostring) +
              "\nDuration: " + ((.stats.duration / 1000) | tostring) + "s"
            ' test-results.json
          fi
          
          if [ -f "playwright-${{ matrix.browser }}-output.log" ]; then
            echo "ğŸ“ Output log: $(wc -l < playwright-${{ matrix.browser }}-output.log) lines"
          fi

      - name: ğŸ“‹ Live Test Console Output
        if: always()
        run: |
          echo "ğŸ–¥ï¸ **RENDERING ${{ matrix.browser }} TEST CONSOLE TO WORKFLOW SUMMARY**"
          
          if [ -f "playwright-${{ matrix.browser }}-output.log" ]; then
            echo "## ğŸ­ ${{ matrix.browser }} Test Output" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -100 "playwright-${{ matrix.browser }}-output.log" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Archive Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
            playwright-${{ matrix.browser }}-output.log
          retention-days: 30
          
      - name: ğŸ“· Archive Test Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-screenshots-${{ matrix.browser }}
          path: |
            test-results/**/*.png
            test-results/**/*.webm
            tests/screenshots/
          retention-days: 30

  test-summary:
    name: ğŸ“‹ Cross-Browser Test Summary
    runs-on: ubuntu-latest
    needs: [pre-flight, test]
    if: always()
    steps:
      - name: ğŸ Test Suite Completion
        run: |
          echo "ğŸ **PLAYWRIGHT CROSS-BROWSER TESTING COMPLETED**"
          echo "ğŸ“… Completed at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Strategy: ${{ needs.pre-flight.outputs.test-strategy }}"
          echo "â±ï¸ Estimated duration: ${{ needs.pre-flight.outputs.estimated-duration }} minutes"
          echo ""
          
          echo "ğŸ“Š **Browser Test Results:**"
          echo "${{ toJson(needs.test.result) }}" | jq -r 'to_entries[] | "âœ… \(.key): \(.value)"' || echo "Result parsing unavailable"

      - name: ğŸ“ PR Comment with Test Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const browsers = ${{ needs.pre-flight.outputs.browser-matrix }};
            const testResults = ${{ toJson(needs.test.result) }};
            
            let passedBrowsers = 0;
            let failedBrowsers = 0;
            let browserDetails = [];
            
            for (const browser of browsers) {
              const result = testResults[browser] || 'unknown';
              if (result === 'success') {
                passedBrowsers++;
                browserDetails.push(`âœ… **${browser}**: All tests passed`);
              } else {
                failedBrowsers++;
                browserDetails.push(`âŒ **${browser}**: Tests failed or incomplete`);
              }
            }
            
            const totalBrowsers = browsers.length;
            const overallStatus = failedBrowsers === 0 ? 'âœ…' : 'âŒ';
            
            const comment = `## ğŸ­ Playwright Cross-Browser Test Results ${overallStatus}
            
            **${passedBrowsers}/${totalBrowsers} browsers passed** 
            
            ### ğŸŒ Browser Test Results:
            ${browserDetails.join('\n')}
            
            ### ğŸ“Š Test Execution Details:
            - **Strategy:** ${{ needs.pre-flight.outputs.test-strategy }}
            - **Test Mode:** ${{ github.event.inputs.test_mode || 'normal' }}
            - **Estimated Duration:** ${{ needs.pre-flight.outputs.estimated-duration }} minutes
            
            ${failedBrowsers > 0 ? 
              `### âš ï¸ Action Required\n${failedBrowsers} browser(s) failed testing. Please review the workflow logs and artifacts for detailed error information.` : 
              `### ğŸ‰ Success!\nAll browser tests passed! Your changes are compatible across all target browsers.`}
            
            [ğŸ“Š View detailed reports and artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ“Š Comprehensive Test Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ­ Playwright Cross-Browser Testing Results
          
          ## ğŸ“Š Execution Overview
          - **Strategy:** ${{ needs.pre-flight.outputs.test-strategy }}
          - **Browser Suite:** ${{ github.event.inputs.browser_suite || 'all' }}
          - **Test Mode:** ${{ github.event.inputs.test_mode || 'normal' }}
          - **Estimated Duration:** ${{ needs.pre-flight.outputs.estimated-duration }} minutes
          - **Actual Completion:** $(date +'%H:%M:%S UTC')
          
          ## ğŸŒ Browser Compatibility Matrix
          | Browser | Status | Details |
          |---------|---------|---------|
          $(echo '${{ needs.pre-flight.outputs.browser-matrix }}' | jq -r '.[] | "| ğŸŒ " + . + " | " + (${{ toJson(needs.test.result) }}[.] // "unknown" | if . == "success" then "âœ… PASSED" else "âŒ FAILED" end) + " | Cross-browser compatibility testing |"')
          
          ## ğŸ¯ Testing Excellence Features
          - **ğŸ­ Multi-Browser Support:** Chromium, Firefox, WebKit testing
          - **ğŸª Flexible Test Modes:** Normal, headed, debug, smoke-only options
          - **ğŸ“Š Comprehensive Reporting:** HTML reports with screenshots and videos
          - **ğŸ–¥ï¸ Live Console Output:** Real-time test execution logs in workflow summary
          - **ğŸ“ˆ Smart Test Strategy:** Adaptive execution based on complexity and mode
          - **ğŸ“± Cross-Platform Testing:** Ubuntu runners with full browser dependencies
          
          ${{ contains(toJson(needs.test.result), 'success') && '## ğŸ‰ Excellent Results!\n\nâœ¨ **Outstanding cross-browser compatibility!** Your application works seamlessly across all target browsers.\n\nğŸš€ **Quality Metrics:**\n- Multi-browser validation complete\n- UI/UX consistency verified\n- Performance across engines tested\n- Accessibility compliance maintained' || '## âš ï¸ Action Required\n\nğŸ” **Browser compatibility issues detected.** Some tests failed across different browsers.\n\nğŸ› ï¸ **Next Steps:**\n- Review failed browser test logs\n- Check for browser-specific issues\n- Verify feature compatibility\n- Update code for cross-browser support' }}
          EOF